#!/bin/bash
# Pre-commit hook matching CI checks
# Install: ln -sf ../../scripts/pre-commit .git/hooks/pre-commit

set -e

echo "Running pre-commit checks..."

# Check if toml-sort is installed
if ! type "toml-sort" > /dev/null 2>&1; then
  echo "Warning: toml-sort not installed. Skipping TOML check."
  echo "Install with: cargo install --git https://github.com/4meta5/toml_sort"
else
  echo "Checking Cargo.toml formatting..."
  ./scripts/check-toml-sorted.sh
fi

# Check cargo fmt
echo "Checking Rust formatting..."
if ! cargo fmt --all -- --check; then
  echo ""
  echo "Rust formatting check failed!"
  echo "Run 'cargo fmt --all' to fix formatting issues."
  exit 1
fi

# Check compilation (matches CI)
echo "Checking compilation..."
export CC_wasm32_unknown_unknown="/opt/homebrew/opt/llvm/bin/clang"
export AR_wasm32_unknown_unknown="/opt/homebrew/opt/llvm/bin/llvm-ar"
export CC_wasm32v1_none="/opt/homebrew/opt/llvm/bin/clang"
export AR_wasm32v1_none="/opt/homebrew/opt/llvm/bin/llvm-ar"
if ! cargo check --all-targets 2>&1; then
  echo ""
  echo "Compilation check failed!"
  exit 1
fi

echo "Pre-commit checks passed!"
